// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  createdAt DateTime @default(now())
  walletLedgers WalletLedger[]

  wallets       Wallet[]
  orders        Order[]
  tradesAsMaker Trade[]  @relation("Maker")
  tradesAsTaker Trade[]  @relation("Taker")
}

model WalletLedger {
  id        String   @id @default(uuid())

  userId    String
  walletId  String
  asset     String

  entryType LEDGER_ENTRY_TYPE
  amount    Decimal  @db.Decimal(36, 18)  // always positive
  direction LEDGER_DIRECTION

  balanceBefore Decimal @db.Decimal(36, 18)
  balanceAfter  Decimal @db.Decimal(36, 18)

  referenceType LEDGER_REFERENCE_TYPE
  referenceId   String?  // tradeId, orderId, withdrawalId, etc

  idempotencyKey String? @unique

  metadata Json?

  createdAt DateTime @default(now())

  wallet Wallet @relation(fields: [walletId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@index([walletId, createdAt])
  @@index([userId, createdAt])
  @@index([referenceId])
}

model Wallet {
  id     String @id @default(uuid())
  userId String
  asset  String

  available Decimal @db.Decimal(36, 18)
  locked    Decimal @db.Decimal(36, 18)

  user   User           @relation(fields: [userId], references: [id])
  ledger WalletLedger[]

  @@unique([userId, asset])
}

model Order {
  id       String @id @default(uuid())
  userId   String
  marketId String

  side   SIDE
  type   ORDER_TYPE
  status ORDER_STATUS @default(PENDING)

  price             Decimal? @db.Decimal(36, 18) // null for MARKET
  originalQuantity  Decimal  @db.Decimal(36, 18)
  remainingQuantity Decimal  @db.Decimal(36, 18)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id])
  market Market @relation(fields: [marketId], references: [id])

  buyTrades  Trade[] @relation("BuyTrades")
  sellTrades Trade[] @relation("SellTrades")

  @@index([marketId, price])
  @@index([marketId, createdAt])
}

model Trade {
  id       String @id @default(uuid())
  marketId String

  buyOrderId  String
  sellOrderId String

  makerId String
  takerId String

  price    Decimal @db.Decimal(36, 18)
  quantity Decimal @db.Decimal(36, 18)

  makerFee Decimal @db.Decimal(36, 18)
  takerFee Decimal @db.Decimal(36, 18)

  executedAt DateTime @default(now())

  market    Market @relation(fields: [marketId], references: [id])
  buyOrder  Order  @relation("BuyTrades", fields: [buyOrderId], references: [id])
  sellOrder Order  @relation("SellTrades", fields: [sellOrderId], references: [id])
  maker     User   @relation("Maker", fields: [makerId], references: [id])
  taker     User   @relation("Taker", fields: [takerId], references: [id])

  @@index([marketId, executedAt])
}

model Market {
  id         String @id @default(uuid())
  symbol     String @unique // BTC_USDT
  baseAsset  String // BTC
  quoteAsset String // USDT
  logo       String

  price Decimal? @db.Decimal(38, 18)

  high24h Decimal? @db.Decimal(38, 18)
  low24h  Decimal? @db.Decimal(38, 18)
  open24h Decimal? @db.Decimal(38, 18)

  volume24h      Decimal? @db.Decimal(38, 18) // base asset
  quoteVolume24h Decimal? @db.Decimal(38, 18)

  change24h   Decimal? @db.Decimal(10, 6) // percentage
  priceChange Decimal? @db.Decimal(38, 18)

  marketCap Decimal? @db.Decimal(38, 18)

  minOrderSize Decimal @db.Decimal(38, 18)
  maxOrderSize Decimal @db.Decimal(38, 18)
  tickSize     Decimal @db.Decimal(38, 18)
  lotSize      Decimal @db.Decimal(38, 18)

  sparkline7d Decimal[] // store scaled values or prices

  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]
  trades Trade[]
}

model Candle {
  id          String @id @default(uuid())
  market    String
  interval    String
  openTime    DateTime
  closeTime   DateTime
  open        Decimal @db.Decimal(38, 18)
  high        Decimal @db.Decimal(38, 18)
  low         Decimal @db.Decimal(38, 18)
  close       Decimal @db.Decimal(38, 18)
  volume      Decimal @db.Decimal(38, 18)
  tradeCount Int     @default(0)

  @@index([market,interval, openTime])
  @@unique([market, interval, openTime])
}

model FeeAccount {
  id      String  @id @default(uuid())
  asset   String
  balance Decimal @db.Decimal(36, 18)
}

enum SIDE {
  BUY
  SELL
}

enum ORDER_TYPE {
  LIMIT
  MARKET
}

enum ORDER_STATUS {
  PENDING
  EXPIRED
  OPEN
  PARTIALLY_FILLED
  FILLED
  CANCELLED
}

enum LEDGER_DIRECTION {
  CREDIT
  DEBIT
}

enum LEDGER_ENTRY_TYPE {
  DEPOSIT
  WITHDRAWAL
  TRADE_EXECUTION
  TRADE_FEE
  ORDER_LOCK
  ORDER_UNLOCK
  REFUND
  ADJUSTMENT
}

enum LEDGER_REFERENCE_TYPE {
  TRADE
  ORDER
  WITHDRAWAL
  DEPOSIT
  SYSTEM
}
